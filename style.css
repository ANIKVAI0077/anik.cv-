// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyD7-4v0NZuFQz-kg3qidn_4HglfR3tXy84",
    authDomain: "shimu-digital-studio.firebaseapp.com",
    projectId: "shimu-digital-studio",
    storageBucket: "shimu-digital-studio.appspot.com",
    messagingSenderId: "852545253639",
    appId: "1:852545253639:web:5f06b13f22d09eaa072384"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// App Configuration
const CONFIG = {
    ADMIN_PASSWORD: "anik0077",
    MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
    MAX_FILES_PER_UPLOAD: 20,
    ALLOWED_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
};

// Global State
let currentUser = null;
let galleryAuthenticated = false;
let noticeAuthenticated = false;
let selectedFiles = [];
let currentSearchResults = [];
let currentGalleryPhotos = [];
let currentModalIndex = 0;
let currentModalContext = '';

// DOM Elements
let elements = {};

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

async function initializeApp() {
    try {
        // Initialize elements
        initializeElements();
        
        // Initialize event listeners
        initializeEventListeners();
        
        // Check Firebase connection
        await checkFirebaseConnection();
        
        // Load initial data
        await loadInitialData();
        
        // Hide loading screen
        setTimeout(() => {
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                showToast('সিস্টেম প্রস্তুত ✓', 'স্বাগতম! শিমু ডিজিটাল স্টুডিও', 'success');
            }, 500);
        }, 2000);
        
    } catch (error) {
        console.error('Initialization error:', error);
        showToast('ত্রুটি', 'সিস্টেম লোড করতে সমস্যা হয়েছে', 'error');
    }
}

function initializeElements() {
    // Tab elements
    elements.tabs = {
        search: document.getElementById('search-tab'),
        upload: document.getElementById('upload-tab'),
        gallery: document.getElementById('gallery-tab'),
        notice: document.getElementById('notice-tab'),
        services: document.getElementById('services-tab')
    };
    
    // Navigation buttons
    elements.navBtns = document.querySelectorAll('.nav-btn');
    
    // Search elements
    elements.searchInput = document.getElementById('search-input');
    elements.searchBtn = document.getElementById('search-btn');
    elements.resultsGrid = document.getElementById('results-grid');
    elements.resultCount = document.getElementById('result-count');
    
    // Upload elements
    elements.uploadForm = document.getElementById('upload-form');
    elements.customerNumber = document.getElementById('customer-number');
    elements.fileInput = document.getElementById('file-input');
    elements.browseBtn = document.getElementById('browse-btn');
    elements.dropArea = document.getElementById('drop-area');
    elements.selectedFiles = document.getElementById('files-list');
    elements.adminPassword = document.getElementById('admin-password');
    elements.showPassword = document.getElementById('show-password');
    elements.cancelUpload = document.getElementById('cancel-upload');
    elements.uploadProgress = document.getElementById('upload-progress');
    elements.progressFill = document.getElementById('progress-fill');
    elements.progressPercent = document.getElementById('progress-percent');
    elements.progressText = document.getElementById('progress-text');
    elements.progressCount = document.getElementById('progress-count');
    
    // Gallery elements
    elements.galleryLogin = document.getElementById('gallery-login');
    elements.galleryPassword = document.getElementById('gallery-password');
    elements.galleryLoginBtn = document.getElementById('gallery-login-btn');
    elements.galleryContent = document.getElementById('gallery-content');
    elements.gallerySearch = document.getElementById('gallery-search');
    elements.refreshGallery = document.getElementById('refresh-gallery');
    elements.logoutGallery = document.getElementById('logout-gallery');
    elements.galleryGrid = document.getElementById('gallery-grid');
    
    // Notice elements
    elements.addNoticeBtn = document.getElementById('add-notice-btn');
    elements.noticesContainer = document.getElementById('notices-container');
    elements.noticeEditor = document.getElementById('notice-editor');
    elements.closeEditor = document.getElementById('close-editor');
    elements.noticeForm = document.getElementById('notice-form');
    elements.noticeTitle = document.getElementById('notice-title');
    elements.noticeContent = document.getElementById('notice-content');
    elements.noticeType = document.getElementById('notice-type');
    elements.noticePassword = document.getElementById('notice-password');
    elements.cancelNotice = document.getElementById('cancel-notice');
    elements.charCount = document.getElementById('char-count');
    
    // Services elements
    elements.servicesGrid = document.getElementById('services-grid');
    elements.servicesManagement = document.getElementById('services-management');
    elements.serviceForm = document.getElementById('service-form');
    elements.closeManagement = document.getElementById('close-management');
    elements.cancelService = document.getElementById('cancel-service');
    
    // Modal elements
    elements.imageModal = document.getElementById('image-modal');
    elements.modalImage = document.getElementById('modal-image');
    elements.imageInfo = document.getElementById('image-info');
    elements.modalClose = document.getElementById('modal-close');
    elements.downloadBtn = document.getElementById('download-btn');
    elements.shareBtn = document.getElementById('share-btn');
    elements.deleteBtn = document.getElementById('delete-btn');
    
    // Theme toggle
    elements.themeToggle = document.getElementById('theme-toggle');
}

function initializeEventListeners() {
    // Theme toggle
    elements.themeToggle.addEventListener('click', toggleTheme);
    
    // Navigation
    elements.navBtns.forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    
    // Search functionality
    elements.searchBtn.addEventListener('click', performSearch);
    elements.searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });
    
    // Upload functionality
    elements.browseBtn.addEventListener('click', () => elements.fileInput.click());
    elements.fileInput.addEventListener('change', handleFileSelection);
    
    // Drag and drop
    elements.dropArea.addEventListener('dragover', handleDragOver);
    elements.dropArea.addEventListener('drop', handleDrop);
    
    // Password toggle
    elements.showPassword.addEventListener('click', togglePasswordVisibility);
    
    // Form submissions
    elements.uploadForm.addEventListener('submit', handleUploadSubmit);
    elements.cancelUpload.addEventListener('click', resetUploadForm);
    
    // Gallery functionality
    elements.galleryLoginBtn.addEventListener('click', handleGalleryLogin);
    elements.logoutGallery.addEventListener('click', handleGalleryLogout);
    elements.refreshGallery.addEventListener('click', loadGalleryPhotos);
    elements.gallerySearch.addEventListener('input', filterGallery);
    
    // Notice functionality
    elements.addNoticeBtn.addEventListener('click', showNoticeEditor);
    elements.closeEditor.addEventListener('click', hideNoticeEditor);
    elements.noticeForm.addEventListener('submit', handleNoticeSubmit);
    elements.cancelNotice.addEventListener('click', hideNoticeEditor);
    elements.noticeContent.addEventListener('input', updateCharCount);
    
    // Services functionality
    elements.closeManagement.addEventListener('click', hideServicesManagement);
    elements.cancelService.addEventListener('click', hideServicesManagement);
    
    // Modal functionality
    elements.modalClose.addEventListener('click', closeModal);
    elements.downloadBtn.addEventListener('click', downloadCurrentImage);
    elements.shareBtn.addEventListener('click', shareCurrentImage);
    elements.deleteBtn.addEventListener('click', deleteCurrentImage);
    
    // Footer links
    document.querySelectorAll('.footer-links a, .footer-nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            if (link.dataset.tab) {
                switchTab(link.dataset.tab);
            }
        });
    });
}

async function checkFirebaseConnection() {
    try {
        // Test Firestore connection
        await db.collection('test').doc('connection').set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'connected'
        });
        
        console.log('✅ Firebase connected successfully');
        return true;
        
    } catch (error) {
        console.error('❌ Firebase connection failed:', error);
        showToast('সতর্কতা', 'ফায়ারবেস সংযোগ নেই, স্থানীয়ভাবে কাজ চলছে', 'warning');
        return false;
    }
}

async function loadInitialData() {
    try {
        // Load stats
        await updateStats();
        
        // Load notices
        await loadNotices();
        
        // Load services
        await loadServices();
        
    } catch (error) {
        console.error('Initial data load error:', error);
    }
}

// ===== THEME FUNCTIONALITY =====
function toggleTheme() {
    const body = document.body;
    const themeIcon = elements.themeToggle.querySelector('i');
    
    if (body.classList.contains('dark-theme')) {
        body.classList.remove('dark-theme');
        themeIcon.className = 'fas fa-moon';
        localStorage.setItem('theme', 'light');
        showToast('থিম পরিবর্তন', 'লাইট মোড চালু হয়েছে', 'info');
    } else {
        body.classList.add('dark-theme');
        themeIcon.className = 'fas fa-sun';
        localStorage.setItem('theme', 'dark');
        showToast('থিম পরিবর্তন', 'ডার্ক মোড চালু হয়েছে', 'info');
    }
}

// ===== TAB NAVIGATION =====
function switchTab(tabId) {
    // Hide all tabs
    Object.values(elements.tabs).forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all nav buttons
    elements.navBtns.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    if (elements.tabs[tabId]) {
        elements.tabs[tabId].classList.add('active');
        
        // Activate corresponding nav button
        document.querySelector(`.nav-btn[data-tab="${tabId}"]`).classList.add('active');
        
        // Load data for the tab
        switch(tabId) {
            case 'gallery':
                if (!galleryAuthenticated) {
                    elements.galleryLogin.style.display = 'block';
                    elements.galleryContent.style.display = 'none';
                }
                break;
        }
    }
}

// ===== SEARCH FUNCTIONALITY =====
async function performSearch() {
    const phoneNumber = elements.searchInput.value.trim();
    
    // Validate phone number
    if (!phoneNumber || !/^01[3-9]\d{8}$/.test(phoneNumber)) {
        showToast('ত্রুটি', 'সঠিক ১১ ডিজিটের মোবাইল নম্বর লিখুন', 'error');
        return;
    }
    
    // Show loading state
    elements.resultsGrid.innerHTML = `
        <div class="loading-results">
            <i class="fas fa-spinner fa-spin"></i>
            <p>ছবি খোঁজা হচ্ছে...</p>
        </div>
    `;
    
    try {
        // Search in Firestore
        const snapshot = await db.collection('photos')
            .where('customerNumber', '==', phoneNumber)
            .orderBy('uploadedAt', 'desc')
            .get();
        
        currentSearchResults = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        if (currentSearchResults.length === 0) {
            elements.resultsGrid.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <p>কোন ছবি পাওয়া যায়নি</p>
                    <p>এই নম্বর দিয়ে কোন ছবি নেই: ${phoneNumber}</p>
                </div>
            `;
            elements.resultCount.textContent = '0 টি ছবি';
            showToast('ফলাফল', 'কোন ছবি পাওয়া যায়নি', 'info');
        } else {
            displaySearchResults(currentSearchResults);
            elements.resultCount.textContent = `${currentSearchResults.length} টি ছবি`;
            showToast('ফলাফল', `${currentSearchResults.length}টি ছবি পাওয়া গেছে`, 'success');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        elements.resultsGrid.innerHTML = `
            <div class="no-results">
                <i class="fas fa-exclamation-triangle"></i>
                <p>সার্চ করতে সমস্যা হয়েছে</p>
                <p>দয়া করে আবার চেষ্টা করুন</p>
            </div>
        `;
        showToast('ত্রুটি', 'সার্চ করতে সমস্যা হয়েছে', 'error');
    }
}

function displaySearchResults(photos) {
    elements.resultsGrid.innerHTML = '';
    
    photos.forEach((photo, index) => {
        const photoCard = createPhotoCard(photo, index, 'search');
        elements.resultsGrid.appendChild(photoCard);
    });
}

function createPhotoCard(photo, index, context) {
    const card = document.createElement('div');
    card.className = 'photo-card';
    
    // Format date
    const uploadDate = photo.uploadDate || 'তারিখ নেই';
    const fileSize = photo.fileSize || 'সাইজ জানা নেই';
    
    card.innerHTML = `
        <img src="${photo.imageUrl}" alt="ছবি" class="photo-image" loading="lazy">
        <div class="photo-info">
            <h4 class="photo-title">ছবি ${index + 1}</h4>
            <div class="photo-details">
                <div class="detail-item">
                    <i class="fas fa-mobile-alt"></i>
                    <span>${photo.customerNumber}</span>
                </div>
                <div class="detail-item">
                    <i class="far fa-calendar"></i>
                    <span>${uploadDate}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-file"></i>
                    <span>${fileSize}</span>
                </div>
            </div>
            <div class="photo-actions">
                <button class="btn-view">
                    <i class="fas fa-eye"></i> দেখুন
                </button>
                <button class="btn-download">
                    <i class="fas fa-download"></i> ডাউনলোড
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners
    const viewBtn = card.querySelector('.btn-view');
    const downloadBtn = card.querySelector('.btn-download');
    
    viewBtn.addEventListener('click', () => {
        showImageModal(photo, index, context);
    });
    
    downloadBtn.addEventListener('click', () => {
        downloadPhoto(photo);
    });
    
    return card;
}

// ===== UPLOAD FUNCTIONALITY =====
function handleDragOver(e) {
    e.preventDefault();
    elements.dropArea.style.borderColor = '#4361ee';
    elements.dropArea.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
}

function handleDrop(e) {
    e.preventDefault();
    elements.dropArea.style.borderColor = '';
    elements.dropArea.style.backgroundColor = '';
    
    if (e.dataTransfer.files.length) {
        elements.fileInput.files = e.dataTransfer.files;
        handleFileSelection();
    }
}

function handleFileSelection() {
    const files = Array.from(elements.fileInput.files);
    selectedFiles = [...selectedFiles, ...files];
    updateSelectedFilesList();
}

function updateSelectedFilesList() {
    elements.selectedFiles.innerHTML = '';
    
    if (selectedFiles.length === 0) {
        elements.selectedFiles.innerHTML = '<p class="empty-files">কোন ফাইল নির্বাচন করা হয়নি</p>';
        return;
    }
    
    selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <i class="fas fa-image"></i>
                <div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                </div>
            </div>
            <button class="remove-file" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Add remove functionality
        const removeBtn = fileItem.querySelector('.remove-file');
        removeBtn.addEventListener('click', () => {
            selectedFiles.splice(index, 1);
            updateSelectedFilesList();
        });
        
        elements.selectedFiles.appendChild(fileItem);
    });
}

function togglePasswordVisibility() {
    const type = elements.adminPassword.type === 'password' ? 'text' : 'password';
    elements.adminPassword.type = type;
    elements.showPassword.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
}

function resetUploadForm() {
    elements.uploadForm.reset();
    selectedFiles = [];
    updateSelectedFilesList();
    elements.uploadProgress.style.display = 'none';
    showToast('ফর্ম রিসেট', 'ফর্ম ক্লিয়ার করা হয়েছে', 'success');
}

async function handleUploadSubmit(e) {
    e.preventDefault();
    
    // Get form data
    const customerNumber = elements.customerNumber.value.trim();
    const adminPassword = elements.adminPassword.value;
    
    // Validation
    if (!customerNumber || !/^01[3-9]\d{8}$/.test(customerNumber)) {
        showToast('ত্রুটি', 'সঠিক ১১ ডিজিটের মোবাইল নম্বর লিখুন', 'error');
        return;
    }
    
    if (selectedFiles.length === 0) {
        showToast('ত্রুটি', 'অন্তত একটি ছবি নির্বাচন করুন', 'error');
        return;
    }
    
    if (adminPassword !== CONFIG.ADMIN_PASSWORD) {
        showToast('ত্রুটি', 'ভুল অ্যাডমিন পাসওয়ার্ড', 'error');
        return;
    }
    
    // Show progress bar
    elements.uploadProgress.style.display = 'block';
    elements.progressFill.style.width = '0%';
    elements.progressPercent.textContent = '0%';
    
    let successCount = 0;
    let failedCount = 0;
    
    try {
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            // Update progress
            const progress = ((i + 1) / selectedFiles.length) * 100;
            elements.progressFill.style.width = `${progress}%`;
            elements.progressPercent.textContent = `${Math.round(progress)}%`;
            elements.progressText.textContent = `আপলোড হচ্ছে: ${file.name}`;
            elements.progressCount.textContent = `${i + 1}/${selectedFiles.length}`;
            
            try {
                // Upload file to Firebase Storage
                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storagePath = `photos/${customerNumber}/${fileName}`;
                const storageRef = storage.ref(storagePath);
                
                // Upload file
                const uploadTask = storageRef.put(file);
                
                // Wait for upload to complete
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Progress tracking
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            elements.progressFill.style.width = `${progress}%`;
                            elements.progressPercent.textContent = `${Math.round(progress)}%`;
                        },
                        reject,
                        async () => {
                            try {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Save photo info to Firestore
                                const photoData = {
                                    customerNumber: customerNumber,
                                    fileName: file.name,
                                    fileSize: formatFileSize(file.size),
                                    uploadDate: new Date().toLocaleString('bn-BD'),
                                    imageUrl: downloadURL,
                                    storagePath: storagePath,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    uploadedBy: 'admin'
                                };
                                
                                await db.collection('photos').add(photoData);
                                successCount++;
                                
                                // Update success count
                                document.getElementById('success-count').textContent = successCount;
                                document.getElementById('total-uploaded').textContent = successCount + failedCount;
                                
                                resolve();
                                
                            } catch (error) {
                                reject(error);
                            }
                        }
                    );
                });
                
            } catch (error) {
                console.error('File upload error:', error);
                failedCount++;
                document.getElementById('failed-count').textContent = failedCount;
            }
        }
        
        // Complete
        elements.progressText.textContent = 'আপলোড সম্পন্ন';
        elements.progressFill.style.width = '100%';
        elements.progressPercent.textContent = '100%';
        
        // Show result
        const message = `${successCount}টি ছবি সফলভাবে আপলোড হয়েছে! ${failedCount > 0 ? `(${failedCount}টি ব্যর্থ)` : ''}`;
        showToast('সফল', message, 'success');
        
        // Reset form after delay
        setTimeout(() => {
            resetUploadForm();
            
            // Update stats
            updateStats();
            
            // Refresh gallery if authenticated
            if (galleryAuthenticated) {
                loadGalleryPhotos();
            }
        }, 3000);
        
    } catch (error) {
        console.error('Upload process error:', error);
        showToast('ত্রুটি', 'আপলোড করতে সমস্যা হয়েছে', 'error');
        elements.uploadProgress.style.display = 'none';
    }
}

// ===== GALLERY FUNCTIONALITY =====
function handleGalleryLogin() {
    const password = elements.galleryPassword.value;
    
    if (password !== CONFIG.ADMIN_PASSWORD) {
        showToast('ত্রুটি', 'ভুল অ্যাডমিন পাসওয়ার্ড', 'error');
        return;
    }
    
    galleryAuthenticated = true;
    elements.galleryLogin.style.display = 'none';
    elements.galleryContent.style.display = 'block';
    
    showToast('সফল', 'অ্যাডমিন হিসাবে লগইন হয়েছে', 'success');
    loadGalleryPhotos();
}

function handleGalleryLogout() {
    galleryAuthenticated = false;
    elements.galleryLogin.style.display = 'block';
    elements.galleryContent.style.display = 'none';
    elements.galleryPassword.value = '';
    showToast('সফল', 'লগআউট করা হয়েছে', 'info');
}

async function loadGalleryPhotos() {
    if (!galleryAuthenticated) return;
    
    try {
        // Show loading
        elements.galleryGrid.innerHTML = `
            <div class="loading-gallery">
                <i class="fas fa-spinner fa-spin"></i>
                <p>গ্যালারি লোড হচ্ছে...</p>
            </div>
        `;
        
        // Get all photos
        const snapshot = await db.collection('photos')
            .orderBy('uploadedAt', 'desc')
            .get();
        
        currentGalleryPhotos = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        // Update gallery stats
        updateGalleryStats(currentGalleryPhotos);
        
        // Display photos
        displayGalleryPhotos(currentGalleryPhotos);
        
    } catch (error) {
        console.error('Gallery load error:', error);
        elements.galleryGrid.innerHTML = `
            <div class="error-gallery">
                <i class="fas fa-exclamation-triangle"></i>
                <p>গ্যালারি লোড করতে সমস্যা</p>
            </div>
        `;
        showToast('ত্রুটি', 'গ্যালারি লোড করতে সমস্যা', 'error');
    }
}

function updateGalleryStats(photos) {
    // Update counts
    document.getElementById('gallery-total').textContent = photos.length;
    
    // Calculate storage size
    const totalSize = photos.reduce((sum, photo) => {
        if (photo.fileSize) {
            const size = parseFileSize(photo.fileSize);
            return sum + size;
        }
        return sum;
    }, 0);
    document.getElementById('gallery-storage').textContent = formatFileSize(totalSize);
    
    // Count unique customers
    const customers = new Set(photos.map(p => p.customerNumber));
    document.getElementById('gallery-customers').textContent = customers.size;
}

function displayGalleryPhotos(photos) {
    if (photos.length === 0) {
        elements.galleryGrid.innerHTML = `
            <div class="empty-gallery">
                <i class="fas fa-images"></i>
                <p>কোন ছবি নেই</p>
                <p>ছবি আপলোড করে শুরু করুন</p>
            </div>
        `;
        return;
    }
    
    elements.galleryGrid.innerHTML = '';
    
    photos.forEach((photo, index) => {
        const galleryItem = createPhotoCard(photo, index, 'gallery');
        elements.galleryGrid.appendChild(galleryItem);
    });
}

function filterGallery() {
    const searchTerm = elements.gallerySearch.value.trim().toLowerCase();
    
    if (!searchTerm) {
        displayGalleryPhotos(currentGalleryPhotos);
        return;
    }
    
    const filtered = currentGalleryPhotos.filter(photo => 
        photo.customerNumber.includes(searchTerm) ||
        (photo.fileName && photo.fileName.toLowerCase().includes(searchTerm))
    );
    
    displayGalleryPhotos(filtered);
}

// ===== NOTICE BOARD FUNCTIONALITY =====
async function loadNotices() {
    try {
        // Show loading
        elements.noticesContainer.innerHTML = `
            <div class="loading-notices">
                <i class="fas fa-spinner fa-spin"></i>
                <p>নোটিশ লোড হচ্ছে...</p>
            </div>
        `;
        
        // Get notices
        const snapshot = await db.collection('notices')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        const notices = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        displayNotices(notices);
        
    } catch (error) {
        console.error('Load notices error:', error);
        elements.noticesContainer.innerHTML = `
            <div class="error-notices">
                <i class="fas fa-exclamation-triangle"></i>
                <p>নোটিশ লোড করতে সমস্যা</p>
            </div>
        `;
    }
}

function displayNotices(notices) {
    if (notices.length === 0) {
        elements.noticesContainer.innerHTML = `
            <div class="empty-notices">
                <i class="fas fa-bullhorn"></i>
                <p>কোন নোটিশ নেই</p>
                <p>প্রথম নোটিশ লিখুন</p>
            </div>
        `;
        return;
    }
    
    elements.noticesContainer.innerHTML = '';
    
    notices.forEach(notice => {
        const noticeCard = createNoticeCard(notice);
        elements.noticesContainer.appendChild(noticeCard);
    });
}

function createNoticeCard(notice) {
    const card = document.createElement('div');
    card.className = `notice-card ${notice.noticeType || 'general'}`;
    
    // Format date
    const createdAt = notice.createdAt ? 
        new Date(notice.createdAt.seconds * 1000).toLocaleString('bn-BD') : 
        'তারিখ নেই';
    
    // Get icon based on type
    let icon = 'fas fa-info-circle';
    switch(notice.noticeType) {
        case 'important': icon = 'fas fa-exclamation-triangle'; break;
        case 'offer': icon = 'fas fa-gift'; break;
        case 'update': icon = 'fas fa-sync-alt'; break;
    }
    
    card.innerHTML = `
        <div class="notice-header-card">
            <div class="notice-title">
                <i class="${icon}"></i>
                <h4>${notice.title}</h4>
            </div>
            <div class="notice-date">${createdAt}</div>
        </div>
        <div class="notice-content">
            ${notice.content}
        </div>
        <div class="notice-footer">
            <div class="notice-author">
                ${notice.createdBy || 'অ্যাডমিন'}
            </div>
            ${noticeAuthenticated ? `
                <div class="notice-actions">
                    <button class="notice-btn" title="এডিট">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="notice-btn" title="ডিলিট">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    return card;
}

function showNoticeEditor() {
    // Request admin password
    const password = prompt('নোটিশ লিখতে অ্যাডমিন পাসওয়ার্ড দিন:');
    
    if (password !== CONFIG.ADMIN_PASSWORD) {
        showToast('ত্রুটি', 'ভুল অ্যাডমিন পাসওয়ার্ড', 'error');
        return;
    }
    
    noticeAuthenticated = true;
    elements.noticeEditor.style.display = 'block';
    elements.noticeEditor.scrollIntoView({ behavior: 'smooth' });
}

function hideNoticeEditor() {
    elements.noticeEditor.style.display = 'none';
    elements.noticeForm.reset();
    elements.charCount.textContent = '0';
}

function updateCharCount() {
    elements.charCount.textContent = elements.noticeContent.value.length;
}

async function handleNoticeSubmit(e) {
    e.preventDefault();
    
    const title = elements.noticeTitle.value.trim();
    const content = elements.noticeContent.value.trim();
    const noticeType = elements.noticeType.value;
    const password = elements.noticePassword.value;
    
    // Validation
    if (!title || !content) {
        showToast('ত্রুটি', 'শিরোনাম ও বিবরণ লিখুন', 'error');
        return;
    }
    
    if (password !== CONFIG.ADMIN_PASSWORD) {
        showToast('ত্রুটি', 'ভুল অ্যাডমিন পাসওয়ার্ড', 'error');
        return;
    }
    
    try {
        // Save notice to Firestore
        const noticeData = {
            title: title,
            content: content,
            noticeType: noticeType,
            createdBy: 'admin',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('notices').add(noticeData);
        
        // Hide editor and reset form
        hideNoticeEditor();
        
        // Reload notices
        await loadNotices();
        
        showToast('সফল', 'নোটিশ সফলভাবে প্রকাশিত হয়েছে', 'success');
        
    } catch (error) {
        console.error('Publish notice error:', error);
        showToast('ত্রুটি', 'নোটিশ প্রকাশ করতে সমস্যা', 'error');
    }
}

// ===== SERVICES FUNCTIONALITY =====
async function loadServices() {
    // Default services
    const defaultServices = [
        {
            title: "ওয়েডিং ফটোগ্রাফি",
            description: "বিয়ে ও ওয়ালিমার সম্পূর্ণ ফটোগ্রাফি ও ভিডিওগ্রাফি সেবা",
            icon: "camera",
            price: "১০,০০০ - ৫০,০০০ টাকা"
        },
        {
            title: "পাসপোর্ট সাইজ ফটো",
            description: "ভিসা, পাসপোর্ট ও সরকারি কাজের জন্য ফটো",
            icon: "id-card",
            price: "১০০ - ৫০০ টাকা"
        },
        {
            title: "স্টুডিও ফটোশুট",
            description: "পারিবারিক, ব্যক্তিগত ও পেশাদার ফটোশুট",
            icon: "camera-retro",
            price: "১,০০০ - ১০,০০০ টাকা"
        },
        {
            title: "ভিডিও এডিটিং",
            description: "প্রফেশনাল ভিডিও এডিটিং ও মন্টাজ",
            icon: "video",
            price: "২,০০০ - ২০,০০০ টাকা"
        },
        {
            title: "ফটো প্রিন্টিং",
            description: "উচ্চ রেজুলেশনে ফটো প্রিন্টিং সেবা",
            icon: "print",
            price: "২০ - ৫০০ টাকা"
        },
        {
            title: "অ্যালবাম তৈরি",
            description: "ডিজিটাল ও হার্ডকপি অ্যালবাম তৈরি",
            icon: "images",
            price: "৫০০ - ৫,০০০ টাকা"
        }
    ];
    
    displayServices(defaultServices);
}

function displayServices(services) {
    elements.servicesGrid.innerHTML = '';
    
    services.forEach(service => {
        const serviceCard = document.createElement('div');
        serviceCard.className = 'service-card';
        
        // Get icon class
        let iconClass = 'fas fa-camera';
        switch(service.icon) {
            case 'video': iconClass = 'fas fa-video'; break;
            case 'edit': iconClass = 'fas fa-edit'; break;
            case 'print': iconClass = 'fas fa-print'; break;
            case 'album': iconClass = 'fas fa-images'; break;
            case 'id-card': iconClass = 'fas fa-id-card'; break;
            case 'camera-retro': iconClass = 'fas fa-camera-retro'; break;
        }
        
        serviceCard.innerHTML = `
            <div class="service-icon">
                <i class="${iconClass}"></i>
            </div>
            <h3 class="service-title">${service.title}</h3>
            <p class="service-description">${service.description}</p>
            <div class="service-price">${service.price}</div>
        `;
        
        elements.servicesGrid.appendChild(serviceCard);
    });
}

function hideServicesManagement() {
    elements.servicesManagement.style.display = 'none';
}

// ===== MODAL FUNCTIONALITY =====
function showImageModal(photo, index, context) {
    currentModalContext = context;
    currentModalIndex = index;
    
    // Set image
    elements.modalImage.src = photo.imageUrl;
    
    // Set image info
    const uploadDate = photo.uploadDate || 'তারিখ নেই';
    const fileSize = photo.fileSize || 'সাইজ জানা নেই';
    
    elements.imageInfo.innerHTML = `
        <div class="info-row">
            <strong>মোবাইল নম্বর:</strong> ${photo.customerNumber}
        </div>
        <div class="info-row">
            <strong>ফাইল নাম:</strong> ${photo.fileName || 'নাম নেই'}
        </div>
        <div class="info-row">
            <strong>আপলোড তারিখ:</strong> ${uploadDate}
        </div>
        <div class="info-row">
            <strong>ফাইল সাইজ:</strong> ${fileSize}
        </div>
    `;
    
    // Show delete button only for gallery context with admin auth
    if (context === 'gallery' && galleryAuthenticated) {
        elements.deleteBtn.style.display = 'block';
        elements.deleteBtn.dataset.id = photo.id;
        elements.deleteBtn.dataset.storagePath = photo.storagePath;
    } else {
        elements.deleteBtn.style.display = 'none';
    }
    
    // Show modal
    elements.imageModal.style.display = 'flex';
}

function closeModal() {
    elements.imageModal.style.display = 'none';
}

function downloadCurrentImage() {
    const link = document.createElement('a');
    link.href = elements.modalImage.src;
    link.download = `shimu_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('সফল', 'ছবি ডাউনলোড শুরু হয়েছে', 'success');
}

function shareCurrentImage() {
    if (navigator.share) {
        navigator.share({
            title: 'শিমু ডিজিটাল স্টুডিও',
            text: 'আমার ছবি দেখুন',
            url: elements.modalImage.src
        }).catch(console.error);
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(elements.modalImage.src)
            .then(() => {
                showToast('সফল', 'ছবির লিংক কপি করা হয়েছে', 'success');
            })
            .catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = elements.modalImage.src;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('সফল', 'ছবির লিংক কপি করা হয়েছে', 'success');
            });
    }
}

async function deleteCurrentImage() {
    const photoId = elements.deleteBtn.dataset.id;
    const storagePath = elements.deleteBtn.dataset.storagePath;
    
    if (!photoId || !confirm('আপনি কি নিশ্চিত এই ছবি ডিলিট করতে চান?')) {
        return;
    }
    
    try {
        // Delete from storage
        if (storagePath) {
            await storage.ref(storagePath).delete();
        }
        
        // Delete from database
        await db.collection('photos').doc(photoId).delete();
        
        // Close modal
        closeModal();
        
        // Refresh gallery
        await loadGalleryPhotos();
        
        // Update stats
        await updateStats();
        
        showToast('সফল', 'ছবি সফলভাবে ডিলিট হয়েছে', 'success');
        
    } catch (error) {
        console.error('Delete image error:', error);
        showToast('ত্রুটি', 'ছবি ডিলিট করতে সমস্যা', 'error');
    }
}

// ===== UTILITY FUNCTIONS =====
function formatFileSize(bytes) {
    if (typeof bytes !== 'number') return '0 Bytes';
    
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function parseFileSize(sizeString) {
    if (typeof sizeString === 'number') return sizeString;
    
    const match = sizeString.match(/(\d+(?:\.\d+)?)\s*(Bytes|KB|MB|GB)/i);
    if (!match) return 0;
    
    const value = parseFloat(match[1]);
    const unit = match[2].toUpperCase();
    
    switch (unit) {
        case 'KB': return value * 1024;
        case 'MB': return value * 1024 * 1024;
        case 'GB': return value * 1024 * 1024 * 1024;
        default: return value;
    }
}

async function updateStats() {
    try {
        // Get photo count
        const photosSnapshot = await db.collection('photos').get();
        const totalPhotos = photosSnapshot.size;
        
        // Get unique customers
        const customerNumbers = new Set();
        photosSnapshot.forEach(doc => {
            customerNumbers.add(doc.data().customerNumber);
        });
        const totalCustomers = customerNumbers.size;
        
        // Get today's uploads
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todaySnapshot = await db.collection('photos')
            .where('uploadedAt', '>=', today)
            .get();
        const todayUploads = todaySnapshot.size;
        
        // Update UI
        document.getElementById('total-photos').textContent = totalPhotos;
        document.getElementById('total-customers').textContent = totalCustomers;
        document.getElementById('today-uploads').textContent = todayUploads;
        
    } catch (error) {
        console.error('Update stats error:', error);
    }
}

function downloadPhoto(photo) {
    const link = document.createElement('a');
    link.href = photo.imageUrl;
    link.download = `shimu_${photo.customerNumber}_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('সফল', 'ছবি ডাউনলোড শুরু হয়েছে', 'success');
}

// ===== TOAST NOTIFICATIONS =====
function showToast(title, message, type = 'info') {
    const container = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fas fa-info-circle';
    switch(type) {
        case 'success': icon = 'fas fa-check-circle'; break;
        case 'error': icon = 'fas fa-exclamation-circle'; break;
        case 'warning': icon = 'fas fa-exclamation-triangle'; break;
    }
    
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="${icon}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Add close event
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    });
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
    
    container.appendChild(toast);
}

// ===== FIREBASE SECURITY RULES =====
/*
// Firestore Rules:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /photos/{document} {
      allow read: if true;
      allow write: if request.time < timestamp.date(2025, 12, 31);
    }
    match /notices/{document} {
      allow read: if true;
      allow write: if request.time < timestamp.date(2025, 12, 31);
    }
  }
}

// Storage Rules:
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /photos/{allPaths=**} {
      allow read: if true;
      allow write: if request.time < timestamp.date(2025, 12, 31);
    }
  }
}
*/